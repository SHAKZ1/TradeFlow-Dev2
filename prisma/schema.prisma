generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Booking {
  id            String   @id @default(cuid())
  opportunityId String   // Links to GHL Lead ID
  userId        String   // Links to Clerk User (Tenancy)
  
  startDate     DateTime
  endDate       DateTime
  title         String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([userId])
}

model User {
  id        String   @id // Clerk ID
  email     String   @unique
  phone     String?  @unique
  firstName String?
  lastName  String?
  imageUrl  String?
  
  ghlLocationId String? @unique
  ghlConfig     Json?   

  documentConfig      Json?
  communicationConfig Json?
  costRates           Json?

  stripeSecretKey      String?
  stripePublishableKey String?

  bankAccountName   String?
  bankSortCode      String?
  bankAccountNumber String?

  companyLogoUrl   String? 
  companyBannerUrl String?
  companyName      String?
  companyNiche     String?  // <--- ADD THIS (e.g. "Emergency Plumber", "High-End Landscaper")
  companyAddress   String?
  companyWebsite   String?
  companyEmail     String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobExpenses JobExpense[]
  aiAdvisorReports AiAdvisorReport[] // <--- ADD THIS LINE
  bookings    Booking[] // <--- ADD THIS LINE
  leads            Lead[]            // <--- ADD THIS LINE
}

model Quote {
  id              String   @id @default(cuid())
  opportunityId   String
  contactId       String
  amount          Float
  type            String
  method          String
  status          String
  stripeSessionId String?  @unique
  paymentUrl      String?
  receiptUrl      String?
  pdfUrl          String?
  paidAt          DateTime? 

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // --- PERFORMANCE INDEX ---
  @@index([opportunityId])
}

model Invoice {
  id              String   @id @default(cuid())
  opportunityId   String
  contactId       String
  amount          Float
  method          String
  status          String
  stripeSessionId String?  @unique
  paymentUrl      String?
  receiptUrl      String?
  pdfUrl          String?
  paidAt          DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // --- PERFORMANCE INDEX ---
  @@index([opportunityId])
}

model JobExpense {
  id            String   @id @default(cuid())
  userId        String
  opportunityId String   
  
  label         String   
  amount        Float    
  category      String   
  date          DateTime @default(now())
  
  subcontractorName  String?
  subcontractorPhone String?
  subcontractorEmail String?
  contractUrl        String? 
  status             String? 

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- PERFORMANCE INDEX ---
  @@index([userId])
  @@index([opportunityId])
}

model AiAdvisorReport {
  id        String   @id @default(cuid())
  userId    String
  
  // The Input Data Snapshot (So we know what data produced this advice)
  inputSnapshot Json 

  // The AI Output (Structured)
  executiveSummary String
  financialAnalysis String
  operationalAdvice String
  marketIntel       String
  actionPlan        Json     // Array of { title, stepByStep, priority }

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

// --- THE IRONCLAD LEAD VAULT ---
model Lead {
  id                  String    @id // GHL Opportunity ID
  userId              String
  contactId           String?
  
  // Identity
  firstName           String    @default("")
  lastName            String    @default("")
  email               String    @default("")
  phone               String    @default("")
  
  // Core Job Data
  value               Float     @default(0)
  status              String    @default("new-lead")
  postcode            String    @default("")
  service             String    @default("")
  source              String    @default("Manual")
  
  // Financial Status
  depositStatus       String    @default("unpaid")
  invoiceStatus       String    @default("unpaid")
  
  // Automation Flags
  autoTexted          Boolean   @default(false)
  
  // Reputation
  reviewStatus        String    @default("none")
  reviewChannel       String?
  reviewScheduledDate DateTime?
  reviewRating        String?
  reviewSource        String?
  reviewText          String?
  
  // Scheduling & Details
  jobDate             DateTime?
  jobEndDate          DateTime?
  notes               String?
  jobSpecs            Json?
  
  // Timestamps
  createdAt           DateTime  @default(now()) // Will map to GHL's original creation date
  updatedAt           DateTime  @updatedAt

  // Relations
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Performance Indexes for lightning-fast dashboard loads
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}